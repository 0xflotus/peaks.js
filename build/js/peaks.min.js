/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*!
 * EventEmitter v4.2.7 - git.io/ee
 * Oliver Caldwell
 * MIT license
 * @preserve
 */

/*! waveform-data - v1.1.2 - 2014-01-30
* https://github.com/bbcrd/waveform-data.js
* Copyright (c) 2014 ; Licensed LGPL-3.0 */

!function(e,t){"function"==typeof define&&define.amd?define(t):window.peaks=t()}(this,function(){var e,t,r;return function(n){function i(e,t){return _.call(e,t)}function a(e,t){var r,n,i,a,o,s,f,m,u,c,d=t&&t.split("/"),h=g.map,l=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(d=d.slice(0,d.length-1),e=d.concat(e.split("/")),m=0;m<e.length;m+=1)if(c=e[m],"."===c)e.splice(m,1),m-=1;else if(".."===c){if(1===m&&(".."===e[2]||".."===e[0]))break;m>0&&(e.splice(m-1,2),m-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((d||l)&&h){for(r=e.split("/"),m=r.length;m>0;m-=1){if(n=r.slice(0,m).join("/"),d)for(u=d.length;u>0;u-=1)if(i=h[d.slice(0,u).join("/")],i&&(i=i[n])){a=i,o=m;break}if(a)break;!s&&l&&l[n]&&(s=l[n],f=m)}!a&&s&&(a=s,o=f),a&&(r.splice(0,o,a),e=r.join("/"))}return e}function o(e,t){return function(){return h.apply(n,b.call(arguments,0).concat([e,t]))}}function s(e){return function(t){return a(t,e)}}function f(e){return function(t){v[e]=t}}function m(e){if(i(w,e)){var t=w[e];delete w[e],y[e]=!0,d.apply(n,t)}if(!i(v,e)&&!i(y,e))throw new Error("No "+e);return v[e]}function u(e){var t,r=e?e.indexOf("!"):-1;return r>-1&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function c(e){return function(){return g&&g.config&&g.config[e]||{}}}var d,h,l,p,v={},w={},g={},y={},_=Object.prototype.hasOwnProperty,b=[].slice;l=function(e,t){var r,n=u(e),i=n[0];return e=n[1],i&&(i=a(i,t),r=m(i)),i?e=r&&r.normalize?r.normalize(e,s(t)):a(e,t):(e=a(e,t),n=u(e),i=n[0],e=n[1],i&&(r=m(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:r}},p={require:function(e){return o(e)},exports:function(e){var t=v[e];return"undefined"!=typeof t?t:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:c(e)}}},d=function(e,t,r,a){var s,u,c,d,h,g,_=[];if(a=a||e,"function"==typeof r){for(t=!t.length&&r.length?["require","exports","module"]:t,h=0;h<t.length;h+=1)if(d=l(t[h],a),u=d.f,"require"===u)_[h]=p.require(e);else if("exports"===u)_[h]=p.exports(e),g=!0;else if("module"===u)s=_[h]=p.module(e);else if(i(v,u)||i(w,u)||i(y,u))_[h]=m(u);else{if(!d.p)throw new Error(e+" missing "+u);d.p.load(d.n,o(a,!0),f(u),{}),_[h]=v[u]}c=r.apply(v[e],_),e&&(s&&s.exports!==n&&s.exports!==v[e]?v[e]=s.exports:c===n&&g||(v[e]=c))}else e&&(v[e]=r)},e=t=h=function(e,t,r,i,a){return"string"==typeof e?p[e]?p[e](t):m(l(e,t).f):(e.splice||(g=e,t.splice?(e=t,t=r,r=null):e=n),t=t||function(){},"function"==typeof r&&(r=i,i=a),i?d(n,e,t,r):setTimeout(function(){d(n,e,t,r)},4),h)},h.config=function(e){return g=e,g.deps&&h(g.deps,g.callback),h},r=function(e,t,r){t.splice||(r=t,t=[]),i(v,e)||i(w,e)||(w[e]=[e,t,r])},r.amd={jQuery:!0}}(),r("almond",function(){}),function(){function e(){}function t(e,t){for(var r=e.length;r--;)if(e[r].listener===t)return r;return-1}function n(e){return function(){return this[e].apply(this,arguments)}}var i=e.prototype,a=this,o=a.EventEmitter;i.getListeners=function(e){var t,r,n=this._getEvents();if(e instanceof RegExp){t={};for(r in n)n.hasOwnProperty(r)&&e.test(r)&&(t[r]=n[r])}else t=n[e]||(n[e]=[]);return t},i.flattenListeners=function(e){var t,r=[];for(t=0;t<e.length;t+=1)r.push(e[t].listener);return r},i.getListenersAsObject=function(e){var t,r=this.getListeners(e);return r instanceof Array&&(t={},t[e]=r),t||r},i.addListener=function(e,r){var n,i=this.getListenersAsObject(e),a="object"==typeof r;for(n in i)i.hasOwnProperty(n)&&-1===t(i[n],r)&&i[n].push(a?r:{listener:r,once:!1});return this},i.on=n("addListener"),i.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},i.once=n("addOnceListener"),i.defineEvent=function(e){return this.getListeners(e),this},i.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},i.removeListener=function(e,r){var n,i,a=this.getListenersAsObject(e);for(i in a)a.hasOwnProperty(i)&&(n=t(a[i],r),-1!==n&&a[i].splice(n,1));return this},i.off=n("removeListener"),i.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},i.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},i.manipulateListeners=function(e,t,r){var n,i,a=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(n=r.length;n--;)a.call(this,t,r[n]);else for(n in t)t.hasOwnProperty(n)&&(i=t[n])&&("function"==typeof i?a.call(this,n,i):o.call(this,n,i));return this},i.removeEvent=function(e){var t,r=typeof e,n=this._getEvents();if("string"===r)delete n[e];else if(e instanceof RegExp)for(t in n)n.hasOwnProperty(t)&&e.test(t)&&delete n[t];else delete this._events;return this},i.removeAllListeners=n("removeEvent"),i.emitEvent=function(e,t){var r,n,i,a,o=this.getListenersAsObject(e);for(i in o)if(o.hasOwnProperty(i))for(n=o[i].length;n--;)r=o[i][n],r.once===!0&&this.removeListener(e,r.listener),a=r.listener.apply(this,t||[]),a===this._getOnceReturnValue()&&this.removeListener(e,r.listener);return this},i.trigger=n("emitEvent"),i.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},i.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},i._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},i._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return a.EventEmitter=o,e},"function"==typeof r&&r.amd?r("EventEmitter",[],function(){return e}):"object"==typeof module&&module.exports?module.exports=e:this.EventEmitter=e}.call(this),r("m/player/waveform/waveform.mixins",[],function(){var e=function(e,t,r){return function(n,i,a,o){var s=0,f=.5,m=e/2-10.5,u=e/2+9.5,c=e,d=r?-19.5:19.5,h=[[f,s],[f,m],[d,m],[d,u],[f,u],[f,c]],l=new Kinetic.Group({draggable:n,dragBoundFunc:function(e){var t;return r?(t=i.outMarker.getX()-i.outMarker.getWidth(),e.x>t&&(e.x=t)):(t=i.inMarker.getX()+i.inMarker.getWidth(),e.x<t&&(e.x=t)),{x:e.x,y:this.getAbsolutePosition().y}}}).on("dragmove",function(){o(i,a)}),p=r?-24:24,v=new Kinetic.Text({x:p,y:e/2-5,text:"",fontSize:10,fontFamily:"sans-serif",fill:"#000",textAlign:"center"});v.hide(),l.label=v,l.add(v);var w=new Kinetic.Polygon({points:h,fill:t,stroke:t,strokeWidth:1}).on("mouseover",function(){v.show(),r&&v.setX(p-v.getWidth()),i.view.segmentLayer.draw()}).on("mouseout",function(){v.hide(),i.view.segmentLayer.draw()});return l.add(w),l}},t=function(e,t,r,n,i,a){e.beginPath(),t.forEach(function(t,r){e.lineTo(n+r+.5,a(t)+.5)}),r.reverse().forEach(function(t,r){e.lineTo(n+(i-r)+.5,a(t)+.5)}),e.closePath()};return{interpolateHeight:function(e){var t=256;return function(r){return e-(r+128)*e/t}},waveformDrawFunction:function(e,r,n){var i=e.offset_length,a=r.getContext();t(a,e.min,e.max,0,i,n),r.fillStroke(this)},waveformSegmentDrawFunction:function(e,r,n,i){if(void 0!==e.segments[r]){var a=e.segments[r],o=a.offset_length,s=a.offset_start-e.offset_start,f=n.getContext();t(f,a.min,a.max,s,o,i),n.fillStroke(this)}},waveformOffsetDrawFunction:function(e,r,n){if(void 0!==e.segments.zoom){var i=e.segments.zoom.offset_length,a=e.segments.zoom.offset_start-e.offset_start,o=r.getContext();t(o,e.segments.zoom.min,e.segments.zoom.max,a,i,n),r.fillStroke(this)}},niceTime:function(e,t){var r,n,i,a,o=[];r=Math.floor(e%1*100),n=Math.floor(e),i=Math.floor(n/60),a=Math.floor(i/60),a>0&&o.push(a),o.push(i%60),o.push(n%60);for(var s=0;s<o.length;s++){var f=o[s];o[s]=10>f?"0"+f:f}return o=o.join(":"),t||(10>r&&(r="0"+r),o+="."+r),o},defaultInMarker:function(t){return e(t.height,t.outMarkerColor,!0)},defaultOutMarker:function(t){return e(t.height,t.outMarkerColor,!1)},defaultSegmentLabelDraw:function(){return function(e,t){return new Kinetic.Text({x:12,y:12,text:t.labelText,fontSize:12,fontFamily:"Arial, sans-serif",fill:"#000",textAlign:"center"})}}}}),r("m/player/player",["m/player/waveform/waveform.mixins"],function(e){var t=function(t){var r={timeFromPercentage:function(e,t){return e*(t/100)}};return{init:function(e){var r=this;this.player=e,this.duration=this.player.duration,4===this.player.readyState&&t.emit("player_load",r),this.player.addEventListener("timeupdate",function(){t.emit("player_time_update",r.getTime())}),this.player.addEventListener("play",function(){t.emit("player_play",r.getTime())}),this.player.addEventListener("pause",function(){t.emit("player_pause",r.getTime())}),this.player.addEventListener("seeked",function(){t.emit("waveform_seek",r.getTime())})},setSource:function(e){this.player.setAttribute("src",e)},getSource:function(){return this.player.src},play:function(){this.player.play(),t.emit("radio_play",this.getTime())},pause:function(){this.player.pause(),t.emit("radio_pause",this.getTime())},getTime:function(){return this.player.currentTime},getTimeFromPercentage:function(t){return e.niceTime(this.duration*t/100,!1)},getSecsFromPercentage:function(e){return Math.floor(this.duration*e/100)},getDuration:function(){return this.duration},getPercentage:function(){return this.getPercentageFromSeconds(this.player.currentTime)},getPercentageFromSeconds:function(e){var t=e/this.duration*100;return Math.round(100*t)/100},seek:function(e){this.player.currentTime=r.timeFromPercentage(this.duration,e)},seekBySeconds:function(e){this.player.currentTime=e}}};return t}),!function(e){"object"==typeof exports?module.exports=e():"function"==typeof r&&r.amd?r("waveform-data",e):"undefined"!=typeof window?window.WaveformData=e():"undefined"!=typeof global?global.WaveformData=e():"undefined"!=typeof self&&(self.WaveformData=e())}(function(){return function e(r,n,i){function a(s,f){if(!n[s]){if(!r[s]){var m="function"==typeof t&&t;if(!f&&m)return m(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var u=n[s]={exports:{}};r[s][0].call(u.exports,function(e){var t=r[s][1][e];return a(t?t:e)},u,u.exports,e,r,n,i)}return n[s].exports}for(var o="function"==typeof t&&t,s=0;s<i.length;s++)a(i[s]);return a}({1:[function(e,t){var r=t.exports=function(e){this.data=e};r.isCompatible=function(e){return e&&"object"==typeof e&&"byteLength"in e},r.fromResponseData=function(e){return new r(new DataView(e))},r.prototype={get version(){return this.data.getInt32(0,!0)},get is_8_bit(){return!!this.data.getUint32(4,!0)},get is_16_bit(){return!this.is_8_bit},get sample_rate(){return this.data.getInt32(8,!0)},get scale(){return this.data.getInt32(12,!0)},get length(){return this.data.getUint32(16,!0)},at:function(e){return Math.round(this.data.getInt8(20+e))}}},{}],2:[function(e,t){t.exports={arraybuffer:e("./arraybuffer.js"),object:e("./object.js")}},{"./arraybuffer.js":1,"./object.js":3}],3:[function(e,t){var r=t.exports=function(e){this.data=e};r.isCompatible=function(e){return e&&"object"==typeof e&&"sample_rate"in e||"string"==typeof e&&"sample_rate"in JSON.parse(e)},r.fromResponseData=function(e){return new r("string"==typeof e?JSON.parse(e):e)},r.prototype={get version(){return this.data.version||1},get is_8_bit(){return 8===this.data.bits},get is_16_bit(){return!this.is_8_bit},get sample_rate(){return this.data.sample_rate},get scale(){return this.data.samples_per_pixel},get length(){return this.data.length},at:function(e){return Math.round(this.data.data[e])}}},{}],4:[function(e,t){var r=e("./segment.js"),n=t.exports=function(e,t){this.adapter=t.fromResponseData(e),this.segments={},this.offset(0,this.adapter.length)};n.create=function(e){var t=null,r=null;if(e&&"object"==typeof e&&("responseText"in e||"response"in e)&&(r="responseType"in e?e.response:e.responseText||e.response),Object.keys(n.adapters).some(function(i){return n.adapters[i].isCompatible(r||e)?(t=n.adapters[i],!0):void 0}),null===t)throw new TypeError("Could not detect a WaveformData adapter from the input.");return new n(r||e,t)},n.prototype={offset:function(e,t){var r=this.adapter.length;if(0>t)throw new RangeError("End point must be non-negative.");if(e>=t)throw new RangeError("We can't end prior to the starting point.");if(0>e)throw new RangeError("Start point must be non-negative.");if(e>=r)throw new RangeError("Start point must be within range.");t>r&&(t=r),this.offset_start=e,this.offset_end=t,this.offset_length=t-e},set_segment:function(e,t,n){return n=n||"default",this.segments[n]=new r(this,e,t),this.segments[n]},resample:function(e){"number"==typeof e&&(e={width:e});var t=[],r=e.scale||Math.floor(this.duration*this.adapter.sample_rate/e.width),i=this.adapter.scale,a=this.adapter.length,o=a?this.min_sample(0):0,s=a?this.max_sample(0):0,f=0,m=0,u=-128,c=127;if(i>r)throw new Error("Zoom level "+r+" too low, minimum: "+i);for(var d,h,l,p,v,w=function(e){return Math.floor(e*r)},g=function(e,r){t.push(e,r)};a>f;){for(;Math.floor(w(m)/i)===f;)m&&g(o,s),v=f,m++,d=w(m),h=w(m-1),d!==h&&(o=c,s=u);for(d=w(m),l=Math.floor(d/i),l>a&&(l=a);l>f;)p=this.min_sample(f),o>p&&(o=p),p=this.max_sample(f),p>s&&(s=p),f++}return f!==v&&g(o,s),new n({version:this.adapter.version,samples_per_pixel:r,length:t.length/2,data:t,sample_rate:this.adapter.sample_rate},n.adapters.object)},get min(){return this.offsetValues(this.offset_start,this.offset_length,0)},get max(){return this.offsetValues(this.offset_start,this.offset_length,1)},offsetValues:function(e,t,r){var n=this.adapter,i=Array.apply(null,new Array(t));return r+=2*e,i.map(function(e,t){return n.at(2*t+r)})},get duration(){return this.adapter.length*this.adapter.scale/this.adapter.sample_rate},get offset_duration(){return this.offset_length*this.adapter.scale/this.adapter.sample_rate},get pixels_per_second(){return this.adapter.sample_rate/this.adapter.scale},get seconds_per_pixel(){return this.adapter.scale/this.adapter.sample_rate},at:function(e){return this.adapter.at(e)},at_time:function(e){return Math.floor(e*this.adapter.sample_rate/this.adapter.scale)},time:function(e){return e*this.seconds_per_pixel},in_offset:function(e){return e>=this.offset_start&&e<this.offset_end},min_sample:function(e){return this.adapter.at(2*e)},max_sample:function(e){return this.adapter.at(2*e+1)}},n.adapters={},n.adapter=function(e){this.data=e}},{"./segment.js":5}],5:[function(e,t){var r=t.exports=function(e,t,r){this.context=e,this.start=t,this.end=r};r.prototype={get offset_start(){return this.start<this.context.offset_start&&this.end>this.context.offset_start?this.context.offset_start:this.start>=this.context.offset_start&&this.start<this.context.offset_end?this.start:null},get offset_end(){return this.end>this.context.offset_start&&this.end<=this.context.offset_end?this.end:this.end>this.context.offset_end&&this.start<this.context.offset_end?this.context.offset_end:null},get offset_length(){return this.offset_end-this.offset_start},get length(){return this.end-this.start},get visible(){return this.context.in_offset(this.start)||this.context.in_offset(this.end)||this.context.offset_start>this.start&&this.context.offset_start<this.end},get min(){return this.visible?this.context.offsetValues(this.offset_start,this.offset_length,0):[]},get max(){return this.visible?this.context.offsetValues(this.offset_start,this.offset_length,1):[]}}},{}],6:[function(e,t){var r=e("./lib/core");r.adapters=e("./lib/adapters"),t.exports=r},{"./lib/adapters":2,"./lib/core":4}]},{},[6])(6)}),r("m/player/waveform/waveform.axis",["m/player/waveform/waveform.mixins"],function(e){function t(e,t){var r=e%t;return 0===r?e:e+t-r}function r(e){this.view=e,this.axisShape=null}return r.prototype.drawAxis=function(e){var t=this;this.axisShape?(this.axisShape.setDrawFunc(function(r){t.axisDrawFunction(r,e)}),this.view.uiLayer.draw()):(this.axisShape=new Kinetic.Shape({drawFunc:function(r){t.axisDrawFunction(r,e)},fill:"rgba(38, 255, 161, 1)",strokeWidth:0}),this.view.uiLayer.add(this.axisShape),this.view.uiLayer.draw())},r.prototype.getAxisLabelScale=function(){for(var e,t=1,r=[1,2,5,10,20,30],n=60,i=0;;){e=t*r[i];var a=this.view.data.at_time(e);if(!(n>a))break;++i==r.length&&(t*=60,i=0)}return e},r.prototype.axisDrawFunction=function(r,n){var i=10,a=this.getAxisLabelScale(),o=t(n,a),s=o-n,f=this.view.data.at_time(s),m=r.getContext();m.strokeStyle="#ccc",m.lineWidth=1,m.font="11px sans-serif",m.fillStyle="#aaa",m.textAlign="left",m.textBaseline="bottom";for(var u=o;x=f+this.view.data.at_time(u-o),!(x>=this.view.width);){m.beginPath(),m.moveTo(x+.5,0),m.lineTo(x+.5,0+i),m.moveTo(x+.5,this.view.height),m.lineTo(x+.5,this.view.height-i),m.stroke();var c=e.niceTime(u,!0),d=m.measureText(c).width,h=x-d/2,l=this.view.height-1-i;h>=0&&m.fillText(c,h,l),u+=a}},r}),r("m/player/waveform/waveform.overview",["m/player/waveform/waveform.axis","m/player/waveform/waveform.mixins"],function(e,t){function r(t,r,n){var i=this;i.options=n.options,i.data=t,i.container=r,i.width=i.container.clientWidth,i.height=i.options.height,i.frameOffset=0,i.seeking=!1,i.stage=new Kinetic.Stage({container:r,width:i.width,height:i.height}),i.waveformLayer=new Kinetic.Layer,i.background=new Kinetic.Rect({x:0,y:0,width:i.width,height:i.height}),i.waveformLayer.add(i.background),i.uiLayer=new Kinetic.Layer,i.refLayer=new Kinetic.Layer,i.axis=new e(i),i.createWaveform(),i.createRefWaveform(),i.axis.drawAxis(0),i.createUi();var a=function(){i.stage.off("mousemove mouseup"),i.seeking=!1};i.stage.on("mousedown",function(e){if(e.targetNode&&!e.targetNode.attrs.draggable&&!e.targetNode.parent.attrs.draggable)if("mousedown"==e.type){i.seeking=!0;var t=i.refWaveformShape.getWidth();i.updateRefWaveform(i.data.time(e.layerX),i.data.time(e.layerX+t)),n.emit("overview_user_seek",i.data.time(e.layerX),e.layerX),i.stage.on("mousemove",function(e){i.updateRefWaveform(i.data.time(e.layerX),i.data.time(e.layerX+t)),n.emit("overview_user_seek",i.data.time(e.layerX),e.layerX)}),i.stage.on("mouseup",a)}else a()}),n.on("player_time_update",function(e){i.seeking||(i.playheadPixel=i.data.at_time(e),i.updateUi(i.playheadPixel))}),n.on("overview_user_seek",function(e,t){i.playheadPixel=t,i.updateUi(i.playheadPixel),i.options.audioElement.currentTime=e}),n.on("waveform_zoom_displaying",function(e,t){i.updateRefWaveform(e,t)}),n.on("resizeEndOverview",function(e,t){i.width=e,i.data=t,i.stage.setWidth(i.width),i.updateWaveform(),n.emit("overview_resized")})}return r.prototype.createWaveform=function(){var e=this;this.waveformShape=new Kinetic.Shape({drawFunc:function(r){t.waveformDrawFunction.call(this,e.data,r,t.interpolateHeight(e.height))},fill:e.options.overviewWaveformColor,strokeWidth:0}),this.waveformLayer.add(this.waveformShape),this.stage.add(this.waveformLayer)},r.prototype.createRefWaveform=function(){var e=this;this.refWaveformShape=new Kinetic.Shape({drawFunc:function(r){t.waveformOffsetDrawFunction.call(this,e.data,r,t.interpolateHeight(e.height))},fill:e.options.zoomWaveformColor,strokeWidth:0}),this.refLayer.add(this.refWaveformShape),this.stage.add(this.refLayer)},r.prototype.createUi=function(){var e=this;this.playheadLine=new Kinetic.Line({points:e._getPlayheadPoints(0),stroke:"rgba(0,0,0,1)",strokeWidth:1}),this.uiLayer.add(this.playheadLine),this.stage.add(this.uiLayer)},r.prototype.updateWaveform=function(){var e=this;e.waveformShape.setDrawFunc(function(r){t.waveformDrawFunction.call(this,e.data,r,t.interpolateHeight(e.height))}),e.waveformLayer.draw()},r.prototype.updateWaveform=function(){var e=this;e.waveformShape.setDrawFunc(function(r){t.waveformDrawFunction.call(this,e.data,r,t.interpolateHeight(e.height))}),e.waveformLayer.draw()},r.prototype.updateRefWaveform=function(e,r){var n=this,i=n.data.at_time(e),a=n.data.at_time(r);n.refWaveformShape.setDrawFunc(function(e){n.data.set_segment(i,a,"zoom"),t.waveformOffsetDrawFunction.call(this,n.data,e,t.interpolateHeight(n.height))}),n.refWaveformShape.setWidth(n.data.at_time(r)-n.data.at_time(e)),n.refLayer.draw()},r.prototype.updateUi=function(e){var t=this;t.playheadLine.setAttr("points",t._getPlayheadPoints(e)),t.uiLayer.draw()},r.prototype._getPlayheadPoints=function(e){var t=this;return[{x:e+.5,y:0},{x:e+.5,y:t.height}]},r}),r("m/player/waveform/waveform.zoomview",["m/player/waveform/waveform.axis","m/player/waveform/waveform.mixins"],function(e,t){function r(t,r,n){var i=this;i.peaks=n,i.options=n.options,i.rootData=t,i.playing=!1,i.seeking=!1,i.current_zoom_level=0,i.data=i.rootData.resample({scale:i.options.zoomLevels[i.current_zoom_level]}),i.playheadPixel=i.data.at_time(i.options.audioElement.currentTime),i.pixelLength=i.data.adapter.length,i.pixelsPerSecond=i.data.pixels_per_second,i.frameOffset=0,i.container=r,i.width=i.container.clientWidth,i.height=i.options.height,i.stage=new Kinetic.Stage({container:r,width:i.width,height:i.height}),i.zoomWaveformLayer=new Kinetic.Layer,i.uiLayer=new Kinetic.Layer,i.background=new Kinetic.Rect({x:0,y:0,width:i.width,height:i.height}),i.zoomWaveformLayer.add(i.background),i.axis=new e(i),i.createZoomWaveform(),i.axis.drawAxis(0),i.createUi(),i.stage.on("mousedown",function(e){if(e.targetNode&&!e.targetNode.attrs.draggable&&!e.targetNode.parent.attrs.draggable&&"mousedown"==e.type){i.seeking=!0;var t,r,n=e.layerX;i.stage.on("mousemove",function(e){t=e.layerX>n?n-e.layerX:1*(n-e.layerX),n=e.layerX,r=i.frameOffset+t,r=0>r?0:r>i.pixelLength-i.width?i.pixelLength-i.width:r,i.seeking=!1,i.frameOffset=r,i.updateZoomWaveform(r)}),i.stage.on("mouseup",function(){i.stage.off("mousemove mouseup"),i.seeking&&i.peaks.emit("zoomview_user_seek",i.data.time(i.frameOffset+n),i.frameOffset+n)})}});var a=function(e){var t=i.data.at_time(e);i.seekFrame(t),i.playing&&i.playFrom(e,t)};i.peaks.on("player_time_update",function(e){i.seeking||i.playing||i.seekFrame(i.data.at_time(e))}),i.peaks.on("player_time_update",function(e){i.seeking||!i.playing||i.data.in_offset(i.data.at_time(e))||i.newFrame(i.frameOffset)}),i.peaks.on("zoomview_user_seek",function(e,t){i.options.audioElement.currentTime=e,i.syncPlayhead(t),i.playing&&i.playFrom(e,i.data.at_time(e))}),i.peaks.on("waveform_seek",a),i.peaks.on("overview_user_seek",a),i.peaks.on("player_play",function(e){i.playing=!0,i.playFrom(e,i.data.at_time(e))}),i.peaks.on("player_pause",function(e){i.playing=!1,i.playheadLineAnimation&&i.playheadLineAnimation.stop(),i.syncPlayhead(i.data.at_time(e))}),i.peaks.on("waveform_zoom_level_changed",function(e){i.playing||e!=i.current_zoom_level&&(i.current_zoom_level=e,i.data=i.rootData.resample({scale:e}),i.pixelsPerSecond=i.data.pixels_per_second,i.seekFrame(i.data.at_time(i.options.audioElement.currentTime)))}),i.peaks.on("window_resized",function(e,t){i.width=e,i.data=t,i.stage.setWidth(i.width),i.updateZoomWaveform(i.frameOffset),i.peaks.emit("zoomview_resized")});var o=function(e){var t=i.options.audioElement.currentTime;t+=i.options.nudgeIncrement*e,i.seekFrame(i.data.at_time(t))};i.peaks.on("kybrd_left",o.bind(i,-1)),i.peaks.on("kybrd_right",o.bind(i,1)),i.peaks.on("kybrd_shift_left",o.bind(i,-10)),i.peaks.on("kybrd_shift_right",o.bind(i,10))}return r.prototype.createZoomWaveform=function(){var e=this;e.zoomWaveformShape=new Kinetic.Shape({drawFunc:function(r){e.data.offset(0,e.width),t.waveformDrawFunction.call(this,e.data,r,t.interpolateHeight(e.height))},fill:e.options.zoomWaveformColor,strokeWidth:0}),e.zoomWaveformLayer.add(e.zoomWaveformShape),e.stage.add(e.zoomWaveformLayer),e.peaks.emit("waveform_zoom_displaying",0*e.data.seconds_per_pixel,e.width*e.data.seconds_per_pixel)},r.prototype.createUi=function(){var e=this;e.zoomPlayheadLine=new Kinetic.Line({points:[{x:0,y:0},{x:0,y:e.height}],stroke:"rgba(0,0,0,1)",strokeWidth:1}),e.zoomPlayheadText=new Kinetic.Text({x:2,y:12,text:"00:00:00",fontSize:11,fontFamily:"sans-serif",fill:"#aaa",align:"right"}),e.zoomPlayheadGroup=new Kinetic.Group({x:0,y:0}).add(e.zoomPlayheadLine).add(e.zoomPlayheadText),e.uiLayer.add(e.zoomPlayheadGroup),e.stage.add(e.uiLayer)},r.prototype.updateZoomWaveform=function(e){var r=this,n=r.playheadPixel>=e&&r.playheadPixel<=e+r.width;if(n){var i=r.playheadPixel-e;r.zoomPlayheadGroup.show().setAttr("x",i+.5),r.zoomPlayheadText.setText(t.niceTime(r.data.time(r.playheadPixel),!1))}else r.zoomPlayheadGroup.hide();r.uiLayer.draw(),r.zoomWaveformShape.setDrawFunc(function(n){r.data.offset(e,e+r.width),t.waveformDrawFunction.call(this,r.data,n,t.interpolateHeight(r.height))}),r.zoomWaveformLayer.draw(),r.axis.drawAxis(r.data.time(e)),r.peaks.emit("waveform_zoom_displaying",e*r.data.seconds_per_pixel,(e+r.width)*r.data.seconds_per_pixel)},r.prototype.playFrom=function(e,t){var r=this;r.playheadLineAnimation&&r.playheadLineAnimation.stop();var n=0;r.playheadLineAnimation=new Kinetic.Animation(function(e){var i=e.time,a=i/1e3,o=Math.round(t-r.frameOffset+r.pixelsPerSecond*(a-n));r.syncPlayhead(r.frameOffset+o)},r.uiLayer),r.playheadLineAnimation.start()},r.prototype.newFrame=function(e){var t=e+this.width;return t<this.data.adapter.length?(this.frameOffset=t,this.updateZoomWaveform(t),!0):!1},r.prototype.syncPlayhead=function(e){var r=this,n=e>=r.frameOffset&&e<=r.frameOffset+r.width;if(r.playheadPixel=e,n){var i=r.playheadPixel-r.frameOffset;r.zoomPlayheadGroup.show().setAttr("x",i+.5),r.zoomPlayheadText.setText(t.niceTime(r.data.time(r.playheadPixel),!1))}else r.zoomPlayheadGroup.hide()},r.prototype.seekFrame=function(e){var t=this,r=t.data.adapter.length-t.width;t.data.in_offset(e)||(t.frameOffset=e>t.width&&r>e?e-Math.round(t.width/2):e>=r?r:0),t.syncPlayhead(e),t.updateZoomWaveform(t.frameOffset)},r}),r("m/player/waveform/waveform.segments",["m/player/waveform/waveform.mixins"],function(e){return function(t){var r=this;r.segments=[],r.views=[t.waveform.waveformZoomView,t.waveform.waveformOverview].map(function(e){return e.segmentLayer||(e.segmentLayer=new Kinetic.Layer,e.stage.add(e.segmentLayer),e.segmentLayer.moveToTop()),e});var n=function(e,n,i,s,f,m){var u={id:e,startTime:n,endTime:i,labelText:m||""},c=new Kinetic.Group,d=new Kinetic.Group,h=[c,d];f=f||o();var l=function(){this.parent.label.show(),this.parent.view.segmentLayer.draw()},p=function(){this.parent.label.hide(),this.parent.view.segmentLayer.draw()};return h.forEach(function(e,n){var i=r.views[n];e.waveformShape=new Kinetic.Shape({fill:f,strokeWidth:0}),e.waveformShape.on("mouseenter",l),e.waveformShape.on("mouseleave",p),e.add(e.waveformShape),e.label=new t.options.segmentLabelDraw(e,u),e.add(e.label.hide()),s&&(e.inMarker=new t.options.segmentInMarker(!0,e,u,a),e.add(e.inMarker),e.outMarker=new t.options.segmentOutMarker(!0,e,u,a),e.add(e.outMarker)),i.segmentLayer.add(e)}),u.zoom=c,u.zoom.view=t.waveform.waveformZoomView,u.overview=d,u.overview.view=t.waveform.waveformOverview,u.color=f,u.editable=s,u},i=function(r){t.waveform.waveformOverview.data.set_segment(t.waveform.waveformOverview.data.at_time(r.startTime),t.waveform.waveformOverview.data.at_time(r.endTime),r.id),t.waveform.waveformZoomView.data.set_segment(t.waveform.waveformZoomView.data.at_time(r.startTime),t.waveform.waveformZoomView.data.at_time(r.endTime),r.id);var n=t.waveform.waveformOverview.data.at_time(r.startTime),i=t.waveform.waveformOverview.data.at_time(r.endTime);r.overview.waveformShape.setDrawFunc(function(n){e.waveformSegmentDrawFunction.call(this,t.waveform.waveformOverview.data,r.id,n,e.interpolateHeight(t.waveform.waveformOverview.height))}),r.overview.setWidth(i-n),r.editable&&(r.overview.inMarker&&r.overview.inMarker.show().setX(n-r.overview.inMarker.getWidth()),r.overview.outMarker&&r.overview.outMarker.show().setX(i),r.overview.inMarker.label.setText(e.niceTime(r.startTime,!1)),r.overview.outMarker.label.setText(e.niceTime(r.endTime,!1)));var a=t.waveform.waveformZoomView.data.at_time(r.startTime),o=t.waveform.waveformZoomView.data.at_time(r.endTime),s=t.waveform.waveformZoomView.frameOffset,f=t.waveform.waveformZoomView.frameOffset+t.waveform.waveformZoomView.width;if(s>a&&(a=s),o>f&&(o=f),t.waveform.waveformZoomView.data.segments[r.id].visible){var m=a-s,u=o-s;r.zoom.show(),r.zoom.waveformShape.setDrawFunc(function(n){e.waveformSegmentDrawFunction.call(this,t.waveform.waveformZoomView.data,r.id,n,e.interpolateHeight(t.waveform.waveformZoomView.height))}),r.editable&&(r.zoom.inMarker&&r.zoom.inMarker.show().setX(m-r.zoom.inMarker.getWidth()),r.zoom.outMarker&&r.zoom.outMarker.show().setX(u),r.zoom.inMarker.label.setText(e.niceTime(r.startTime,!1)),r.zoom.outMarker.label.setText(e.niceTime(r.endTime,!1)))}else r.zoom.hide()},a=function(e,t){if(e.inMarker.getX()>0){var n=e.view.frameOffset+e.inMarker.getX()+e.inMarker.getWidth();t.startTime=e.view.data.time(n)}if(e.outMarker.getX()<e.view.width){var a=e.view.frameOffset+e.outMarker.getX();t.endTime=e.view.data.time(a)}i(t),r.render()},o=function(){var e;if(t.options.randomizeSegmentColor){var r=function(){return Math.floor(255*Math.random())};e="rgba("+r()+", "+r()+", "+r()+", 1)"}else e=t.options.segmentColor;return e};this.init=function(){t.on("waveform_zoom_displaying",r.updateSegments)},this.updateSegments=function(){r.segments.forEach(i),r.render()},this.createSegment=function(e,t,a,o,s){var f="segment"+r.segments.length;if(e>=0==!1)throw new TypeError("[waveform.segments.createSegment] startTime should be a positive value");if(t>0==!1)throw new TypeError("[waveform.segments.createSegment] endTime should be a positive value");if(t>e==!1)throw new RangeError("[waveform.segments.createSegment] endTime should be higher than startTime");var m=n(f,e,t,a,o,s);return i(m),r.segments.push(m),m},this.render=function(){r.views.forEach(function(e){e.segmentLayer.draw()})}}}),r("m/player/waveform/waveform.core",["waveform-data","m/player/waveform/waveform.overview","m/player/waveform/waveform.zoomview","m/player/waveform/waveform.segments"],function(e,t,r,n){return function(i){return{init:function(r){var n=i.options;this.ui=r;var a=this,o=new XMLHttpRequest,s="withCredentials"in o;s||(console&&console.info&&console.info("Changing request type to .json as browser does not support ArrayBuffer"),n.dataUri=n.dataUri.replace(/\.dat$/i,".json")),o.open("GET",n.dataUri,!0),n.dataUri.match(/\.json$/i)?s&&(o.responseType="json"):o.responseType="arraybuffer",o.onload=function(t){4===this.readyState&&200===this.status&&f(e.create(t.target))},o.send();var f=function(e){a.origWaveformData=e;var r=a.origWaveformData.resample(a.ui.player.clientWidth);a.waveformOverview=new t(r,a.ui.overview,i),i.emit("waveformOverviewReady"),a.bindResize()}},openZoomView:function(){var e=this;e.waveformZoomView=new r(e.origWaveformData,e.ui.zoom,i),i.emit("waveform_zoom_start"),e.segments=new n(i),e.segments.init()},bindResize:function(){var e=this;window.addEventListener("resize",function(){e.ui.overview.hidden=!0,e.ui.zoom.hidden=!0,this.resizeTimeoutId&&clearTimeout(this.resizeTimeoutId),this.resizeTimeoutId=setTimeout(function(){var t=e.ui.player.clientWidth,r=e.origWaveformData.resample(t);i.emit("resizeEndOverview",t,r),i.emit("window_resized",t,e.origWaveformData)},500)}),i.on("overview_resized",function(){e.ui.overview.removeAttribute("hidden")}),i.on("zoomview_resized",function(){e.ui.zoom.removeAttribute("hidden")})}}}}),r("m/player/player.keyboard",[],function(){function e(e){return function(a){var o=a.keyCode,s=a.type;if(-1===["OBJECT","TEXTAREA","INPUT","SELECT","OPTION"].indexOf(a.target.nodeName))if([t,r,n,i].indexOf(a.type)>-1&&a.preventDefault(),"keydown"===s||"keypress"===s)switch(o){case t:e.emit("kybrd_space");break;case r:e.emit("kybrd_tab")}else if("keyup"===s)switch(o){case n:e.emit(a.shiftKey?"kybrd_shift_left":"kybrd_left");break;case i:e.emit(e.shiftKey?"kybrd_shift_right":"kybrd_right")}}}var t=32,r=9,n=37,i=39;return{init:function(t){document.addEventListener("keydown",e(t)),document.addEventListener("keypress",e(t)),document.addEventListener("keyup",e(t))}}}),t.config({paths:{m:"waveform_viewer"}}),r("main",["EventEmitter","m/player/player","m/player/waveform/waveform.core","m/player/waveform/waveform.mixins","m/player/player.keyboard"],function(e,t,r,n,i){function a(e){this.options={zoomLevels:[512,1024,2048,4096],keyboard:!1,nudgeIncrement:.01,inMarkerColor:"#a0a0a0",outMarkerColor:"#a0a0a0",zoomWaveformColor:"rgba(0, 225, 128, 1)",overviewWaveformColor:"rgba(0,0,0,0.2)",randomizeSegmentColor:!0,height:200,segmentColor:"rgba(255, 161, 39, 1)",template:['<div class="waveform">','<div class="zoom-container"></div>','<div class="overview-container"></div>',"</div>"].join("")},this.container=e,this.currentZoomLevel=0
}var o=function(e){return{player:e.querySelector(".waveform"),zoom:e.querySelector(".zoom-container"),overview:e.querySelector(".overview-container")}},s=function(e,t){for(var r in t)e[r]=t[r];return e};return a.init=function(e){if(e=e||{},!e.audioElement)throw new Error("Please provide an audio element.");if(!(e.audioElement instanceof HTMLMediaElement))throw new TypeError("[Peaks.init] The audioElement option should be an HTMLMediaElement.");if(!e.dataUri)throw new TypeError("[Peaks.init] The dataUri option is mandatory.");if(!e.container)throw new Error("Please provide a container object.");if(e.container.clientWidth>0==!1)throw new TypeError("Please ensure that the container has a width.");var f=new a(e.container);if(s(f.options,e),s(f.options,{segmentInMarker:n.defaultInMarker(f.options),segmentOutMarker:n.defaultOutMarker(f.options),segmentLabelDraw:n.defaultSegmentLabelDraw(f.options)}),"string"==typeof f.options.template)f.container.innerHTML=f.options.template;else{if(!(f.options.template instanceof HTMLElement))throw new TypeError("Please ensure you provide an HTML string or a DOM template as `template` instance option. Provided: "+f.options.template);f.container.appendChild(f.options.template)}return f.options.keyboard&&i.init(f),f.player=new t(f),f.player.init(f.options.audioElement),f.waveform=new r(f),f.waveform.init(o(f.container)),f.on("waveformOverviewReady",function(){f.waveform.openZoomView(),f.options.segments&&f.segments.addSegment(f.options.segments)}),f},a.prototype=Object.create(e.prototype,{segments:{get:function(){var e=this;return{addSegment:function(t,r,n,i,a){var o=arguments[0];if("number"==typeof o&&(o=[{startTime:t,endTime:r,editable:n,color:i,labelText:a}]),!Array.isArray(o))throw new TypeError("[Peaks.segments.addSegment] Unrecognized segment parameters.");o.forEach(function(t){e.waveform.segments.createSegment(t.startTime,t.endTime,t.editable,t.color,t.labelText)}),e.waveform.segments.render()},getSegments:function(){return e.waveform.segments.segments}}}},time:{get:function(){var e=this;return{setCurrentTime:function(t){return e.player.seekBySeconds(t)},getCurrentTime:function(){return e.player.getTime()}}}},zoom:{get:function(){var e=this;return{zoomIn:function(){e.zoom.setZoom(e.currentZoomLevel-1)},zoomOut:function(){e.zoom.setZoom(e.currentZoomLevel+1)},setZoom:function(t){t>=e.options.zoomLevels.length&&(t=e.options.zoomLevels.length-1),0>t&&(t=0),e.currentZoomLevel=t,e.emit("waveform_zoom_level_changed",e.options.zoomLevels[t])},getZoom:function(){return e.currentZoomLevel}}}}}),a}),t("main")});